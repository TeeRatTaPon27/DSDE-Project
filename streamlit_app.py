# üìä Component 1: AI/ML Component
# ‡∏°‡∏µ 2 ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô AI/ML:

# 1. DBSCAN Clustering (‡πÉ‡∏ô Tab Main - Dashboard)
    # ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: Unsupervised Learning - Clustering
    # ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
    # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á cluster ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà

# 2. Linear Regression Analysis (‡πÉ‡∏ô Tab PM2.5 Analysis)
    # ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: Supervised Learning - Regression
    # ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö PM2.5 ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏Å‡∏≤‡∏£ regression ‡∏ö‡∏ô scatter plot
    
# üó∫Ô∏è Component 3: Visualization - Geospatial Analysis
# ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Geospatial Visualization:

# 1. PyDeck Heatmap (‡πÉ‡∏ô Tab PM2.5 Analysis)
    # ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: Heatmap visualization
    # ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏≠‡∏á PM2.5 ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø

# 2. PyDeck Scatterplot (DBSCAN Clustering) (‡πÉ‡∏ô Tab Main)
    # ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: Point map with clustering
    # ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ DBSCAN

# 3. Interactive Map with OpenStreetMap
    # ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: Interactive map base layer
    # ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ‡πÉ‡∏´‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø‡πÄ‡∏õ‡πá‡∏ô background

# 4. Plotly Line Chart
    # ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° PM2.5 ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤

# 5. Plotly Scatter Plot with Regression
    # ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡πâ‡∏ô regression

# 6. Plotly Bar Chart
    # ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ‡πÅ‡∏™‡∏î‡∏á 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

# --------------------------------------------
# ‚úÖ ‡∏™‡∏£‡∏∏‡∏õ Compliance:
    # Component 1: AI/ML (‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)
        # ‚úÖ DBSCAN Clustering - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        # ‚úÖ Linear Regression - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå PM2.5 ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        # ‚úÖ Correlation Analysis - ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£

    # Component 3: Visualization - Geospatial Analysis (‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)
        # ‚úÖ PyDeck Heatmap - ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á PM2.5
        # ‚úÖ PyDeck Scatterplot with DBSCAN - ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏° clustering
        # ‚úÖ Interactive Map with OSM - ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø interactive
        # ‚úÖ Interactive Tooltips - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover
        # ‚úÖ Map Controls - ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏™‡∏µ


import streamlit as st
import pandas as pd
import re
import time
from sklearn.cluster import DBSCAN
import pydeck as pdk
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime, timedelta

#!!!!!!!!!!! Edit this PATH !!!!!!!!!!!!
# df_clean_organization_path = "C:\Users\USER\Documents\Data_Science\FinalProject\DSDE-Project\dataset\df_clean_organization.csv"
# bkk_pm25_daily_2023_path = "C:\Users\USER\Documents\Data_Science\FinalProject\DSDE-Project\dataset\bkk_pm25_daily_2023_all_fast.csv"

# ---------------------------
# Load PM2.5 Data with Progress
# ---------------------------
@st.cache_data(show_spinner=False)
def load_pm25_data_with_progress():
    """‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø"""
    progress = st.progress(0, text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5...")
    
    # STEP 1: load CSV
    progress.progress(25, text="‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå...")
    pm25_df = pd.read_csv(r"C:\Users\USER\Documents\I_love_my_job\CurseOfLife_Season_2\Data_Science\FinalProject\DSDE-Project\dataset\bkk_pm25_daily_2023_all_fast.csv")
    time.sleep(0.3)
    
    # STEP 2: ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    progress.progress(50, text="‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5...")
    pm25_df.rename(columns={'date': 'date_str'}, inplace=True)
    pm25_df['date_dt'] = pd.to_datetime(pm25_df['date_str'], errors='coerce')
    pm25_df.dropna(subset=['date_dt', 'lon', 'lat', 'pm2_5'], inplace=True)
    
    # STEP 3: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Quarter ‡πÅ‡∏•‡∏∞ Month
    progress.progress(75, text="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...")
    pm25_df['quarter'] = pm25_df['date_dt'].dt.quarter
    pm25_df['month'] = pm25_df['date_dt'].dt.month
    pm25_df['year'] = pm25_df['date_dt'].dt.year
    
    # STEP 4: ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)
    progress.progress(100, text="‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5...")
    time.sleep(0.3)
    
    return pm25_df

def prepare_map_data(df):
    """‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà"""
    progress = st.progress(0, text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...")
    step = 0
    total_step = 5

    # 1) ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå lat/lon
    step += 1
    progress.progress(int(100 * step/total_step),
                      text=f"‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ... ({step}/{total_step})")
    time.sleep(0.1)

    # 2) ‡∏•‡∏ö‡∏Ñ‡πà‡∏≤ NaN
    step += 1
    df = df.dropna(subset=["lat", "lon"])
    progress.progress(int(100 * step/total_step),
                      text=f"‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ... ({step}/{total_step})")
    time.sleep(0.1)

    # 3) Convert type
    step += 1
    df["lat"] = df["lat"].astype(float)
    df["lon"] = df["lon"].astype(float)
    progress.progress(int(100 * step/total_step),
                      text=f"‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö lat/lon ... ({step}/{total_step})")
    time.sleep(0.05)

    # 4) Limit number of points (optional) ‚Üí ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô map ‡∏ä‡πâ‡∏≤
    step += 1
    if len(df) > 30000:  
        df = df.sample(30000)  # ‡∏à‡∏≥‡∏Å‡∏±‡∏î 30k ‡∏à‡∏∏‡∏î
    progress.progress(int(100 * step/total_step),
                      text=f"‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û ... ({step}/{total_step})")
    time.sleep(0.1)

    # 5) ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
    step += 1
    progress.progress(100, text="‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‚úì")
    time.sleep(0.1)

    return df

# ---------------------------
# Load Data with Progress Bar (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
# ---------------------------
@st.cache_data(show_spinner=False)
def load_data_with_progress():
    progress = st.progress(0, text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
    status = st.empty()

    # STEP 1: load CSV
    progress.progress(20, text="‡πÇ‡∏´‡∏•‡∏î CSV ...")
    df = pd.read_csv(r"C:\Users\USER\Documents\I_love_my_job\CurseOfLife_Season_2\Data_Science\FinalProject\DSDE-Project\dataset\df_clean_organization.csv")
    time.sleep(0.3)

    # STEP 2: parse type text ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
    progress.progress(40, text="‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• type ...")
    def parse_type(value):
        if pd.isna(value):
            return []
        value = str(value).replace("{", "").replace("}", "")
        parts = re.split(r'\s*,\s*', value)
        return [p.strip() for p in parts if p.strip()]
    
    df["type_list"] = df["type"].apply(parse_type)
    
    # üî• **‡πÄ‡∏Å‡πá‡∏ö ID ‡∏´‡∏£‡∏∑‡∏≠ index ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ñ‡∏™‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö**
    df["original_index"] = df.index
    df["complaint_id"] = df.index.astype(str)  # ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ ID ‡∏≠‡∏∑‡πà‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    
    time.sleep(0.3)

    # STEP 3: explode rows ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ß‡πâ
    progress.progress(60, text="‡πÅ‡∏¢‡∏Å‡πÅ‡∏ñ‡∏ß (explode) ...")
    df_exploded = df.explode("type_list")
    df_exploded.rename(columns={"type_list": "type_exploded"}, inplace=True)
    df_exploded["timestamp_dt"] = pd.to_datetime(df_exploded["timestamp"], errors="coerce")

    # -----------------------
    # Clean type_exploded
    # -----------------------
    df_exploded['type_exploded'] = df_exploded['type_exploded'].astype(str) \
        .str.strip() \
        .str.replace(r"[\[\]']", "", regex=True)
    df_exploded = df_exploded[df_exploded['type_exploded'] != ""]

    time.sleep(0.3)

    # STEP 4: extract coords
    progress.progress(80, text="‡∏î‡∏∂‡∏á lat/lon ‡∏à‡∏≤‡∏Å coords ...")
    df_exploded['coords'] = df_exploded['coords'].astype(str)
    df_exploded[['lon', 'lat']] = df_exploded['coords'].str.extract(
        r'(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)'
    ).astype(float)
    time.sleep(0.3)

    # STEP 5: drop missing
    progress.progress(100, text="‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ...")
    df_exploded = df_exploded.dropna(
        subset=["lat", "lon", "district", "subdistrict", "type_exploded"]
    )
    time.sleep(0.3)

    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Quarter ‡πÅ‡∏•‡∏∞ Month ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå PM2.5
    df_exploded['quarter'] = df_exploded['timestamp_dt'].dt.quarter
    df_exploded['month'] = df_exploded['timestamp_dt'].dt.month
    df_exploded['year'] = df_exploded['timestamp_dt'].dt.year
    
    status.success("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
    
    # üî• **‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢ (‡∏Å‡πà‡∏≠‡∏ô explode)**
    df_original = df.copy()  # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô explode
    
    return {
        'df_exploded': df_exploded,
        'df_original': df_original  # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
    }

# üî• **‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥**
def count_unique_complaints(df_filtered_exploded, df_original=None):
    """
    ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (unique complaints)
    ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ original_index ‡∏´‡∏£‡∏∑‡∏≠ complaint_id
    """
    if df_original is None:
        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ df_original ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏≥‡∏£‡∏≠‡∏á
        if 'original_index' in df_filtered_exploded.columns:
            unique_indices = df_filtered_exploded['original_index'].nunique()
            return unique_indices
        else:
            # ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ timestamp + coords ‡πÄ‡∏õ‡πá‡∏ô unique key
            unique_keys = set()
            for idx, row in df_filtered_exploded.iterrows():
                if 'timestamp' in df_filtered_exploded.columns and 'coords' in df_filtered_exploded.columns:
                    key = f"{row['timestamp']}_{row['coords']}"
                    unique_keys.add(key)
                else:
                    # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÉ‡∏ä‡πâ index ‡πÄ‡∏õ‡πá‡∏ô fallback
                    unique_keys.add(idx)
            return len(unique_keys)
    
    # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ original_index ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
    if 'original_index' in df_filtered_exploded.columns:
        unique_indices = df_filtered_exploded['original_index'].nunique()
        return unique_indices
    
    # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ original_index ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô
    unique_keys = set()
    for idx, row in df_filtered_exploded.iterrows():
        # ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô df_original
        if 'timestamp' in df_filtered_exploded.columns and 'coords' in df_filtered_exploded.columns:
            # ‡πÉ‡∏ä‡πâ timestamp + coords ‡πÄ‡∏õ‡πá‡∏ô unique key
            key = f"{row['timestamp']}_{row['coords']}"
            unique_keys.add(key)
        else:
            # ‡πÉ‡∏ä‡πâ index ‡πÄ‡∏õ‡πá‡∏ô fallback
            unique_keys.add(idx)
    
    return len(unique_keys)

# üî• **‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ï‡∏≤‡∏° filter**
def get_original_complaints(df_filtered_exploded, df_original):
    """
    ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏™‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (‡∏Å‡πà‡∏≠‡∏ô explode) ‡∏à‡∏≤‡∏Å filter ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö df_exploded
    """
    if 'original_index' in df_filtered_exploded.columns:
        # ‡πÉ‡∏ä‡πâ original_index ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å df_original
        filtered_indices = df_filtered_exploded['original_index'].unique()
        result_df = df_original[df_original.index.isin(filtered_indices)].copy()
        return result_df
    
    # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ original_index ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô
    unique_complaints = []
    seen_keys = set()
    
    for _, row in df_filtered_exploded.iterrows():
        # ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô df_original
        if 'timestamp' in row and 'coords' in row:
            mask = (df_original['timestamp'] == row['timestamp']) & \
                   (df_original['coords'] == row['coords'])
            if mask.any():
                # ‡πÉ‡∏ä‡πâ timestamp + coords ‡πÄ‡∏õ‡πá‡∏ô unique key
                key = f"{row['timestamp']}_{row['coords']}"
                if key not in seen_keys:
                    seen_keys.add(key)
                    unique_complaints.append(df_original[mask].iloc[0].to_dict())
    
    return pd.DataFrame(unique_complaints) if unique_complaints else pd.DataFrame()

def create_aqi_heatmap():
    # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å color scale ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏° AQI ‡πÑ‡∏ó‡∏¢
    # ‡πÉ‡∏ä‡πâ linear gradient ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≤
    
    # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á AQI
    color_range = [
        [0, 25, [0, 255, 0, 150]],      # üü¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (0-25 ¬µg/m¬≥)
        [26, 37, [255, 255, 0, 150]],   # üü° ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (26-37)
        [38, 50, [255, 165, 0, 150]],   # üü† ‡∏™‡πâ‡∏° (38-50)
        [51, 90, [255, 0, 0, 150]],     # üî¥ ‡πÅ‡∏î‡∏á (51-90)
        [91, 120, [128, 0, 128, 150]],  # üü£ ‡∏°‡πà‡∏ß‡∏á (91-120)
        [121, 500, [139, 69, 19, 150]]  # üü§ ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (>120)
    ]
    
    # ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ color scale ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    aqi_colorscale = [
        [0, "rgb(0, 255, 0)"],    # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
        [0.2, "rgb(255, 255, 0)"], # ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
        [0.4, "rgb(255, 165, 0)"], # ‡∏™‡πâ‡∏°
        [0.6, "rgb(255, 0, 0)"],   # ‡πÅ‡∏î‡∏á
        [0.8, "rgb(128, 0, 128)"], # ‡∏°‡πà‡∏ß‡∏á
        [1.0, "rgb(139, 69, 19)"]  # ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
    ]

# ---------------------------
# Function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ PM2.5 ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
# ---------------------------
def find_nearest_pm25(pm25_data, lat, lon, date, radius_km=2.0):
    """
    ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ PM2.5 ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
    radius_km: ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£
    """
    # ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)
    radius_deg = radius_km / 111.0  # 1 ‡∏≠‡∏á‡∏®‡∏≤ ‚âà 111 ‡∏Å‡∏°.
    
    # ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    date_only = pd.Timestamp(date).date()
    same_day_data = pm25_data[pd.to_datetime(pm25_data['date_dt']).dt.date == date_only]
    
    if len(same_day_data) == 0:
        return None
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
    same_day_data = same_day_data.copy()
    same_day_data['distance'] = np.sqrt(
        (same_day_data['lat'] - lat) ** 2 + 
        (same_day_data['lon'] - lon) ** 2
    )
    
    # ‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
    nearby_stations = same_day_data[same_day_data['distance'] <= radius_deg]
    
    if len(nearby_stations) == 0:
        return None
    
    # ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ PM2.5 ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
    return nearby_stations['pm2_5'].mean()

# ---------------------------
# ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Streamlit App
# ---------------------------
st.set_page_config(page_title="Bangkok Complaint & PM2.5 Analysis", layout="wide")

# ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô filter
if 'filter_applied' not in st.session_state:
    st.session_state['filter_applied'] = False

# ---------------------------
# Tabs
# ---------------------------
tab_load, tab_main, tab_pm25 = st.tabs(["üìä Loading Status", "üìç Dashboard", "üò∑ PM2.5 Analysis"])

# ---------------------------
# Tab 1: Loading Status
# ---------------------------
with tab_load:
    st.subheader("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å..."):
        data_dict = load_data_with_progress()
        df_exploded = data_dict['df_exploded']
        df_original = data_dict['df_original']
    
    with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5..."):
        pm25_df = load_pm25_data_with_progress()
    
    col1, col2 = st.columns(2)
    with col1:
        st.success("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞ cache ‡πÅ‡∏•‡πâ‡∏ß")
        # ‡∏ô‡∏±‡∏ö unique complaints
        unique_count = count_unique_complaints(df_exploded, df_original)
        exploded_count = len(df_exploded)
        st.info(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥: {unique_count:,} ‡πÄ‡∏Ñ‡∏™")
        st.info(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏£‡∏ß‡∏°‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó): {exploded_count:,} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        st.write(f"‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: {df_exploded['timestamp_dt'].min().date()} ‡∏ñ‡∏∂‡∏á {df_exploded['timestamp_dt'].max().date()}")
        
    with col2:
        st.success("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞ cache ‡πÅ‡∏•‡πâ‡∏ß")
        st.info(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: {len(pm25_df):,} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        st.write(f"‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: {pm25_df['date_dt'].min().date()} ‡∏ñ‡∏∂‡∏á {pm25_df['date_dt'].max().date()}")
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    with st.expander("üëÅÔ∏è ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö)"):
        st.dataframe(df_original.head(10))
    
    with st.expander("üëÅÔ∏è ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏´‡∏•‡∏±‡∏á explode)"):
        st.dataframe(df_exploded.head(10))
        
    with st.expander("üëÅÔ∏è ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5"):
        st.dataframe(pm25_df.head(10))

# ---------------------------
# Tab 2: Dashboard (Main) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
# ---------------------------
with tab_main:
    # Sidebar Filter
    st.sidebar.header("Filters")
    
    districts = ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + sorted(df_exploded["district"].unique())
    selected_district = st.sidebar.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï", districts)

    subdistricts = ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + sorted(df_exploded["subdistrict"].unique())
    selected_subdistrict = st.sidebar.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Ç‡∏ß‡∏á", subdistricts)

    types = sorted(df_exploded["type_exploded"].unique())
    selected_types = st.sidebar.multiselect("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤", types)

    # Organization dropdown (‡∏´‡∏•‡∏±‡∏Å)
    organizations = ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + sorted(df_exploded["organization"].dropna().unique())
    selected_org = st.sidebar.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏´‡∏•‡∏±‡∏Å", organizations)

    # Organization List (‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
    all_org_lists = sorted(
        {org for lst in df_exploded["organization_list"] for org in lst if isinstance(lst, list)}
    )
    selected_org_multi = st.sidebar.multiselect("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ (organization_list)", all_org_lists)
    
    # Filtering
    df_filtered = df_exploded.copy()

    # ‡πÄ‡∏Ç‡∏ï
    if selected_district != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
        df_filtered = df_filtered[df_filtered["district"] == selected_district]

    # ‡πÅ‡∏Ç‡∏ß‡∏á
    if selected_subdistrict != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
        df_filtered = df_filtered[df_filtered["subdistrict"] == selected_subdistrict]

    # ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤
    if selected_types:
        df_filtered = df_filtered[df_filtered["type_exploded"].isin(selected_types)]

    # ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏´‡∏•‡∏±‡∏Å
    if selected_org != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
        df_filtered = df_filtered[df_filtered["organization"] == selected_org]

    # ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (list)
    if selected_org_multi:
        df_filtered = df_filtered[
            df_filtered["organization_list"].apply(
                lambda lst: any(o in lst for o in selected_org_multi)
            )
        ]
        
    # -----------------------------
    # Time Filter (Thai Calendar UI)
    # -----------------------------
    st.sidebar.subheader("‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Timestamp)")
    
    # default range
    min_date = df_exploded["timestamp_dt"].min().date()
    max_date = df_exploded["timestamp_dt"].max().date()

    # date UI (show Thai locale)
    start_date = st.sidebar.date_input("‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏û.‡∏®.)", min_date)
    end_date = st.sidebar.date_input("‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏û.‡∏®.)", max_date)
    
    confirm_button = st.sidebar.button('‚úÖ Apply Filters', key='apply_main')

    # filter by datetime
    if confirm_button:
        df_filtered = df_filtered[
            (df_filtered["timestamp_dt"].dt.date >= start_date) &
            (df_filtered["timestamp_dt"].dt.date <= end_date)
        ]
    
    st.sidebar.subheader("üó∫Ô∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà")

    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    visualization_mode = st.sidebar.radio(
        "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:",
        ["üå´Ô∏è Heatmap (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô)", "üé® Point Colors (‡∏£‡∏∞‡∏î‡∏±‡∏ö AQI)", "üìä ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö"],
        index=0,
        key="visualization_mode_radio"  # üî• ‡πÄ‡∏û‡∏¥‡πà‡∏° key ‡∏ô‡∏µ‡πâ
    )

    # -----------------------------
    # Display Metrics (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
    # -----------------------------
    st.header("üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    
    # ‡∏ô‡∏±‡∏ö unique complaints
    unique_count = count_unique_complaints(df_filtered, df_original)
    exploded_count = len(df_filtered)
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric("üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)", f"{unique_count:,}")
        if exploded_count > unique_count:
            st.caption(f"üìã (‡∏£‡∏ß‡∏°‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: {exploded_count:,})")
    
    with col2:
        # ‡∏ô‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
        unique_types = df_filtered['type_exploded'].nunique()
        st.metric("üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á", f"{unique_types}")
        
        # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞
        if selected_types:
            st.caption(f"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: {len(selected_types)} ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó")
    
    with col3:
        # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏´‡∏•‡∏±‡∏Å
        if selected_org != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
            # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ô‡∏µ‡πâ
            df_org_exploded = df_filtered[df_filtered["organization"] == selected_org]
            org_unique_count = count_unique_complaints(df_org_exploded, df_original)
            
            if org_unique_count >= 50:
                # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì rating
                df_org_original = get_original_complaints(df_org_exploded, df_original)
                if 'star' in df_org_original.columns and len(df_org_original) > 0:
                    avg_rating = df_org_original["star"].mean()
                    st.metric("‚≠ê Rating ‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£", f"{avg_rating:.2f}")
                else:
                    st.info(f"‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ {selected_org} ‡∏°‡∏µ {org_unique_count:,} ‡πÄ‡∏Ñ‡∏™")
            else:
                st.info(f"‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ {selected_org} ‡∏°‡∏µ {org_unique_count:,} ‡πÄ‡∏Ñ‡∏™ ‚Äî ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á Rating (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 50 ‡πÄ‡∏Ñ‡∏™)")
        else:
            st.metric("üè¢ ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", f"{df_filtered['organization'].nunique():,}")
    
    # -----------------------------
    # Cases Count by Time Range (‡πÉ‡∏ä‡πâ unique count)
    # -----------------------------
    st.subheader("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤")
    
    if len(df_filtered) > 0:
        now = df_filtered["timestamp_dt"].max()
        
        ranges = {
            "1 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î": now - pd.Timedelta(days=1),
            "3 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î": now - pd.Timedelta(days=3),
            "7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î": now - pd.Timedelta(days=7),
            "2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î": now - pd.Timedelta(days=14),
            "1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î": now - pd.Timedelta(days=30),
            "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î": df_filtered["timestamp_dt"].min(),
        }

        cols = st.columns(3)
        for idx, (label, start_time) in enumerate(ranges.items()):
            # ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö unique
            temp_filtered = df_filtered[df_filtered["timestamp_dt"] >= start_time]
            unique_count_time = count_unique_complaints(temp_filtered, df_original)
            
            with cols[idx % 3]:
                st.metric(label, f"{unique_count_time:,} ‡πÄ‡∏Ñ‡∏™")
    else:
        st.warning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å")
    
    # -----------------------------
    # Top 10 Bar Chart (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
    # -----------------------------
    st.subheader("‚≠ê Top 10 ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î")
    
    if df_filtered.empty:
        st.warning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å")
    else:
        # üî• **‡∏ô‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤**
        type_counts = {}
        
        # ‡πÉ‡∏ä‡πâ original_index ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if 'original_index' in df_filtered.columns:
            for type_name in df_filtered['type_exploded'].unique():
                # ‡∏´‡∏≤ unique indices ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ
                type_indices = df_filtered[df_filtered['type_exploded'] == type_name]['original_index'].unique()
                type_counts[type_name] = len(type_indices)
        else:
            # ‡πÉ‡∏ä‡πâ timestamp + coords ‡πÄ‡∏õ‡πá‡∏ô unique key
            for type_name in df_filtered['type_exploded'].unique():
                type_data = df_filtered[df_filtered['type_exploded'] == type_name]
                unique_keys = set()
                for _, row in type_data.iterrows():
                    key = f"{row['timestamp']}_{row['coords']}"
                    unique_keys.add(key)
                type_counts[type_name] = len(unique_keys)
        
        # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô DataFrame ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
        top_10_types = pd.DataFrame({
            '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤': list(type_counts.keys()),
            '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™': list(type_counts.values())
        }).sort_values('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™', ascending=False).head(10)
        
        # 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Bar Chart
        fig = px.bar(
            top_10_types,
            x="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™",
            y="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤",
            orientation='h',
            title="10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ô‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)",
            color="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™",
            color_continuous_scale='Viridis'
        )
        
        # ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á layout
        fig.update_layout(
            yaxis={'categoryorder':'total ascending'},
            plot_bgcolor='rgba(0,0,0,0)',
            xaxis=dict(showgrid=False)
        )
        
        # ‡πÅ‡∏™‡∏î‡∏á note ‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
        st.caption("‚ÑπÔ∏è ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (1 ‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 1 ‡πÄ‡∏Ñ‡∏™)")
        
        st.plotly_chart(fig, use_container_width=True)
        
    # ---------------------------
    # Status Map
    # ---------------------------
    st.subheader("üìã ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£")
    
    if df_filtered.empty:
        st.warning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å")
    else:
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞..."):
            df_status_map = prepare_map_data(df_filtered)
            
            # ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'status' ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô)
            # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå status ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å timestamp ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            if 'state' in df_status_map.columns:
                # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå status
                status_colors = {
                    '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': [0, 255, 0, 180],      # üü¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': [0, 0, 255, 180], # üîµ ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô  
                    '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á': [255, 0, 0, 180],      # üî¥ ‡πÅ‡∏î‡∏á
                }
                
                # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                df_status_map['color'] = df_status_map['state'].apply(
                    lambda x: status_colors.get(x, [150, 150, 150, 180])  # ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ default
                )
            else:
                # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå status ‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô
                st.info("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'status' ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ...")
                
                # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (timestamp ‡πÄ‡∏Å‡πà‡∏≤ = ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô, ‡πÉ‡∏´‡∏°‡πà = ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)
                current_time = pd.Timestamp.now()
                
                def assign_status_by_time(timestamp):
                    """‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤"""
                    time_diff = current_time - timestamp
                    days_diff = time_diff.days
                    
                    if days_diff > 30:
                        return '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'      # ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 30 ‡∏ß‡∏±‡∏ô
                    elif days_diff > 7:
                        return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'  # 7-30 ‡∏ß‡∏±‡∏ô
                    else:
                        return '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á'     # ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 7 ‡∏ß‡∏±‡∏ô
                
                # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå status
                df_status_map['state'] = df_status_map['timestamp_dt'].apply(assign_status_by_time)
                
                # ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                status_colors = {
                    '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': [0, 255, 0, 180],      # üü¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': [0, 0, 255, 180], # üîµ ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
                    '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á': [255, 0, 0, 180],      # üî¥ ‡πÅ‡∏î‡∏á
                }
                
                df_status_map['color'] = df_status_map['state'].apply(
                    lambda x: status_colors.get(x, [150, 150, 150, 180])
                )
            
            # ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ô‡∏±‡∏ö unique)
            status_counts = {}
            if 'original_index' in df_status_map.columns:
                # ‡∏ô‡∏±‡∏ö unique by status
                for status in df_status_map['state'].unique():
                    indices = df_status_map[df_status_map['state'] == status]['original_index'].unique()
                    status_counts[status] = len(indices)
            else:
                # ‡∏ô‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡∏≠‡∏≤‡∏à‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥)
                status_counts = df_status_map['state'].value_counts()
            
            # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("üü¢ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô", f"{status_counts.get('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 0):,}")
            with col2:
                st.metric("üîµ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", f"{status_counts.get('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', 0):,}")
            with col3:
                st.metric("üî¥ ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á", f"{status_counts.get('‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á', 0):,}")
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            status_layer = pdk.Layer(
                "ScatterplotLayer",
                data=df_status_map,
                get_position='[lon, lat]',
                get_color="color",
                get_radius=40,
                pickable=True,
                opacity=0.7,
            )
            
            view_state = pdk.ViewState(
                latitude=df_status_map["lat"].mean(),
                longitude=df_status_map["lon"].mean(),
                zoom=11,
            )
            
            r = pdk.Deck(
                layers=[status_layer],
                initial_view_state=view_state,
                tooltip={
                    "html": """
                    <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> {state}<br>
                    <b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</b> {type_exploded}<br>
                    <b>‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£:</b> {organization}<br>
                    <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> {timestamp_dt}<br>
                    <b>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</b> ({lat:.4f}, {lon:.4f})
                    """,
                    "style": {"color": "white", "backgroundColor": "#333", "padding": "5px"}
                }
            )
            
            st.pydeck_chart(r)
            
            # ‡πÅ‡∏™‡∏î‡∏á Legend
            st.markdown("""
            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px;">
                <div style="text-align: center;">
                    <div style="width: 20px; height: 20px; background-color: rgb(0, 255, 0); border-radius: 50%; display: inline-block;"></div>
                    <div>üü¢ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
                </div>
                <div style="text-align: center;">
                    <div style="width: 20px; height: 20px; background-color: rgb(0, 0, 255); border-radius: 50%; display: inline-block;"></div>
                    <div>üîµ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                </div>
                <div style="text-align: center;">
                    <div style="width: 20px; height: 20px; background-color: rgb(255, 0, 0); border-radius: 50%; display: inline-block;"></div>
                    <div>üî¥ ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
                </div>
            </div>
            """, unsafe_allow_html=True)
    
    # ---------------------------
    # Map with Clustering
    # ---------------------------
    st.header("üó∫Ô∏è ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (DBSCAN Clustering)")

    if df_filtered.empty:
        st.warning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å")
    else:
        with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà..."):
            df_map = prepare_map_data(df_filtered)

            # DBSCAN Clustering
            coords = df_map[["lat", "lon"]].to_numpy()
            clustering = DBSCAN(eps=0.002, min_samples=10).fit(coords)
            df_map["cluster"] = clustering.labels_
            
            # ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if selected_org != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                highlight_color = [0, 120, 255]   # ‡∏ü‡πâ‡∏≤
                normal_color = [180, 180, 180]    # ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô

                df_map["color"] = df_map["organization"].apply(
                    lambda x: highlight_color if x == selected_org else normal_color
                )

            elif selected_org_multi:
                highlight_color = [255, 100, 0]    # ‡∏™‡πâ‡∏°
                normal_color = [180, 180, 180]

                df_map["color"] = df_map["organization_list"].apply(
                    lambda lst: highlight_color if any(o in lst for o in selected_org_multi) else normal_color
                )

            else:
                # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏µ‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞ cluster
                unique_clusters = sorted(df_map["cluster"].unique())
                colors = {
                    c: [np.random.randint(50,255), np.random.randint(50,255), np.random.randint(50,255)]
                    for c in unique_clusters
                }
                # cluster = -1 ‡∏Ñ‡∏∑‡∏≠ noise ‚Üí ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤
                colors[-1] = [150,150,150]

                df_map["color"] = df_map["cluster"].apply(lambda c: colors[c])

            # PyDeck Visualization
            layer = pdk.Layer(
                "ScatterplotLayer",
                data=df_map,
                get_position='[lon, lat]',
                get_color="color",
                get_radius=40,
                pickable=True,
                opacity=0.7,
            )
            
            # üî• **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏≠‡∏≤ organization points layer ‡∏≠‡∏≠‡∏Å**
            # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
            if selected_org != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                try:
                    # ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
                    org_loc_df = pd.read_csv("dataset/bkk_osm_organization_locations.csv")
                    
                    # ‡∏ó‡∏≥ clean ‡∏ä‡∏∑‡πà‡∏≠
                    org_loc_df['name_norm'] = org_loc_df['name'].str.strip().str.lower()
                    
                    # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    selected_org_norm = selected_org.strip().lower()
                    org_points = org_loc_df[org_loc_df['name_norm'] == selected_org_norm].copy()
                    
                    if len(org_points) > 0:
                        # ‡∏™‡∏£‡πâ‡∏≤‡∏á layer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
                        layer_org = pdk.Layer(
                            "ScatterplotLayer",
                            data=org_points,
                            get_position=["lon", "lat"],
                            get_radius=200,
                            get_fill_color=[255, 0, 0, 180],
                            radius_min_pixels=8,
                            pickable=True,
                        )
                        layers = [layer, layer_org]
                        
                        # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
                        st.info(f"üìç ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£: **{selected_org}**")
                    else:
                        layers = [layer]
                        st.warning(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£: **{selected_org}** ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
                
                except Exception as e:
                    layers = [layer]
                    st.warning(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÑ‡∏î‡πâ: {str(e)}")
            
            # üî• **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÉ‡∏ô organization_list**
            elif selected_org_multi and len(selected_org_multi) > 0:
                try:
                    # ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
                    org_loc_df = pd.read_csv("dataset/bkk_osm_organization_locations.csv")
                    
                    # ‡∏ó‡∏≥ clean ‡∏ä‡∏∑‡πà‡∏≠
                    org_loc_df['name_norm'] = org_loc_df['name'].str.strip().str.lower()
                    
                    # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    selected_orgs_norm = [org.strip().lower() for org in selected_org_multi]
                    org_points = org_loc_df[org_loc_df['name_norm'].isin(selected_orgs_norm)].copy()
                    
                    if len(org_points) > 0:
                        # ‡∏™‡∏£‡πâ‡∏≤‡∏á layer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
                        layer_org = pdk.Layer(
                            "ScatterplotLayer",
                            data=org_points,
                            get_position=["lon", "lat"],
                            get_radius=200,
                            get_fill_color=[255, 0, 0, 180],
                            radius_min_pixels=8,
                            pickable=True,
                        )
                        layers = [layer, layer_org]
                        
                        # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
                        org_names = ", ".join(selected_org_multi)
                        st.info(f"üìç ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£: **{org_names}**")
                    else:
                        layers = [layer]
                        st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
                
                except Exception as e:
                    layers = [layer]
                    st.warning(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÑ‡∏î‡πâ: {str(e)}")
            
            # üî• **‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÉ‡∏î‡πÜ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")**
            else:
                layers = [layer]
                st.info("‚ÑπÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÉ‡∏ô Filter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ô‡∏±‡πâ‡∏ô")
                
            # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Tab Load ‡∏´‡∏£‡∏∑‡∏≠ Tab Main
            with st.expander("üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"):
                st.write("### ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")
                st.write(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: {count_unique_complaints(df_exploded, df_original):,}")
                st.write(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó): {len(df_exploded):,}")
                st.write(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á: {df_exploded['timestamp_dt'].dt.date.nunique():,}")
                st.write(f"‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {df_exploded['timestamp_dt'].min().date()} ‡∏ñ‡∏∂‡∏á {df_exploded['timestamp_dt'].max().date()}")
                
                # ‡∏ô‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô (unique)
                daily_unique_counts = {}
                for date in df_exploded['timestamp_dt'].dt.date.unique():
                    day_data = df_exploded[df_exploded['timestamp_dt'].dt.date == date]
                    daily_unique_counts[date] = count_unique_complaints(day_data, df_original)
                
                max_count = max(daily_unique_counts.values()) if daily_unique_counts else 0
                avg_count = np.mean(list(daily_unique_counts.values())) if daily_unique_counts else 0
                
                st.write(f"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: {max_count:,} ‡πÄ‡∏Ñ‡∏™")
                st.write(f"‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô: {avg_count:.1f} ‡πÄ‡∏Ñ‡∏™")

            view_state = pdk.ViewState(
                latitude=df_map["lat"].mean(),
                longitude=df_map["lon"].mean(),
                zoom=11,
            )

            r = pdk.Deck(
                layers=layers,
                initial_view_state=view_state,
                tooltip={
                    "html": "<b>Cluster:</b> {cluster}<br>"
                            "<b>Type:</b> {type_exploded}<br>"
                            "<b>Organization:</b> {organization}<br>"
                            "<b>Lat:</b> {lat:.4f}<br>"
                            "<b>Lon:</b> {lon:.4f}",
                    "style": {"color": "white", "backgroundColor": "#333", "padding": "5px"}
                }
            )

            st.pydeck_chart(r)

# ---------------------------
# Tab 3: PM2.5 Analysis (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
# ---------------------------
with tab_pm25:
    st.header("üò∑ ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå PM2.5 ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")
    
    # Sidebar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Filter PM2.5
    st.sidebar.header("PM2.5 Analysis Filters")
    
    # Filter ‡∏õ‡∏µ
    available_years = sorted(pm25_df['year'].unique())
    selected_year = st.sidebar.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ", available_years, key='pm25_year')
    
    # Filter ‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™
    quarters = ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + sorted(pm25_df['quarter'].unique())
    selected_quarter = st.sidebar.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™", quarters, key='pm25_quarter')
    
    # Filter ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    months = ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + sorted(pm25_df['month'].unique())
    selected_month = st.sidebar.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", months, key='pm25_month')
    
    # Filter ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
    districts_complaints = ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + sorted(df_exploded['district'].unique())
    selected_pm25_district = st.sidebar.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï (‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)", districts_complaints, key='pm25_district')
    
    # Filter ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤ - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ PM2.5 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    complaint_types = sorted(df_exploded['type_exploded'].unique())
    # ‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö PM2.5
    pm25_related_types = [t for t in complaint_types if any(keyword in t.lower() for keyword in 
                                                           ['pm2.5', 'pm25', '‡∏ù‡∏∏‡πà‡∏ô', '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', '‡∏°‡∏•‡∏û‡∏¥‡∏©', '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®'])]
    
    if len(pm25_related_types) > 0:
        selected_complaint_type = st.sidebar.selectbox(
            "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤ PM2.5", 
            ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + pm25_related_types, 
            key='pm25_type'
        )
    else:
        selected_complaint_type = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
        st.sidebar.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö PM2.5 ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    
    # Filter PM2.5 Level
    pm25_range = st.sidebar.slider(
        "‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≤ PM2.5 (¬µg/m¬≥)",
        min_value=int(pm25_df['pm2_5'].min()),
        max_value=int(pm25_df['pm2_5'].max()),
        value=(0, 100),
        key='pm25_range'
    )
    
    # üî• **‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà**
    st.sidebar.subheader("üó∫Ô∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà")
    visualization_mode_pm25 = st.sidebar.radio(
        "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:",
        ["üå´Ô∏è Heatmap (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô)", "üé® Point Colors (‡∏£‡∏∞‡∏î‡∏±‡∏ö AQI)", "üìä ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö"],
        index=0,
        key='visualization_mode_pm25'
    )
    
    apply_pm25_filter = st.sidebar.button('üöÄ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå PM2.5', key='apply_pm25')
    
    if apply_pm25_filter:
        with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..."):
            
            # ========================================
            # 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î
            # ========================================
            pm25_filtered = pm25_df.copy()
            
            # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ
            pm25_filtered = pm25_filtered[pm25_filtered['year'] == selected_year]
            
            # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™
            if selected_quarter != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                pm25_filtered = pm25_filtered[pm25_filtered['quarter'] == selected_quarter]
            
            # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            if selected_month != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                pm25_filtered = pm25_filtered[pm25_filtered['month'] == selected_month]
            
            # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≤ PM2.5
            pm25_filtered = pm25_filtered[
                (pm25_filtered['pm2_5'] >= pm25_range[0]) & 
                (pm25_filtered['pm2_5'] <= pm25_range[1])
            ]
            
            # ========================================
            # 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô PM2.5
            # ========================================
            complaints_filtered = df_exploded.copy()
            
            # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö PM2.5
            complaints_filtered = complaints_filtered[complaints_filtered['year'] == selected_year]
            
            # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™
            if selected_quarter != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                complaints_filtered = complaints_filtered[complaints_filtered['quarter'] == selected_quarter]
            
            # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            if selected_month != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                complaints_filtered = complaints_filtered[complaints_filtered['month'] == selected_month]
            
            # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡∏ï
            if selected_pm25_district != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                complaints_filtered = complaints_filtered[complaints_filtered['district'] == selected_pm25_district]
            
            # üî• **‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤ PM2.5**
            if selected_complaint_type != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                complaints_filtered = complaints_filtered[complaints_filtered['type_exploded'] == selected_complaint_type]
            elif len(pm25_related_types) > 0:
                complaints_filtered = complaints_filtered[complaints_filtered['type_exploded'].isin(pm25_related_types)]
            
            # üî• **‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥**
            unique_complaints_count = count_unique_complaints(complaints_filtered, df_original)
            
            # ========================================
            # 3. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            # ========================================
            st.subheader("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
            
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.metric("üìÖ ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", selected_year)
                st.metric("üìà ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PM2.5 (‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ)", f"{len(pm25_filtered):,}")
                avg_pm25 = pm25_filtered['pm2_5'].mean()
                st.metric("üå´Ô∏è ‡∏Ñ‡πà‡∏≤ PM2.5 ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ)", f"{avg_pm25:.1f} ¬µg/m¬≥")
            
            with col2:
                quarter_text = f"‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ {selected_quarter}" if selected_quarter != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" else "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
                st.metric("üìä ‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™", quarter_text)
                # üî• **‡πÉ‡∏ä‡πâ unique count ‡πÅ‡∏ó‡∏ô**
                st.metric("üìù ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô PM2.5", f"{unique_complaints_count:,}")
                
                # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì rating ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
                if unique_complaints_count > 0:
                    original_complaints = get_original_complaints(complaints_filtered, df_original)
                    if 'star' in original_complaints.columns and len(original_complaints) > 0:
                        avg_rating = original_complaints['star'].mean()
                        st.metric("‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", f"{avg_rating:.2f}")
                    else:
                        st.metric("‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", "N/A")
                else:
                    st.metric("‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", "N/A")
            
            with col3:
                month_text = f"‡πÄ‡∏î‡∏∑‡∏≠‡∏ô {selected_month}" if selected_month != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" else "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
                st.metric("üóìÔ∏è ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", month_text)
                if selected_pm25_district != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                    st.metric("üìç ‡πÄ‡∏Ç‡∏ï", selected_pm25_district)
                else:
                    st.metric("üìç ‡πÄ‡∏Ç‡∏ï", "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
                
                if selected_complaint_type != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                    st.metric("üîß ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤", selected_complaint_type)
                else:
                    st.metric("üîß ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤", "PM2.5 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
            
            # ‡πÅ‡∏™‡∏î‡∏á note ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö
            if unique_complaints_count != len(complaints_filtered):
                st.info(f"‚ÑπÔ∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {len(complaints_filtered):,} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤) ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ {unique_complaints_count:,} ‡πÄ‡∏Ñ‡∏™")
            
            # ========================================
            # 4. Visualization: PM2.5 ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
            # ========================================
            st.subheader("üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡πà‡∏≤ PM2.5 ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤")
            
            if len(pm25_filtered) > 0:
                # ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                pm25_daily = pm25_filtered.groupby('date_dt')['pm2_5'].mean().reset_index()
                pm25_daily.sort_values('date_dt', inplace=True)
                
                fig_pm25 = px.line(
                    pm25_daily,
                    x='date_dt',
                    y='pm2_5',
                    title=f'‡∏Ñ‡πà‡∏≤ PM2.5 ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î ({selected_year})',
                    labels={'date_dt': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'pm2_5': 'PM2.5 (¬µg/m¬≥)'},
                    markers=True
                )
                
                # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô WHO (15 ¬µg/m¬≥)
                fig_pm25.add_hline(
                    y=15, 
                    line_dash="dash", 
                    line_color="red",
                    annotation_text="‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô WHO (15 ¬µg/m¬≥)",
                    annotation_position="bottom right"
                )
                
                # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢ (50 ¬µg/m¬≥)
                fig_pm25.add_hline(
                    y=50, 
                    line_dash="dash", 
                    line_color="orange",
                    annotation_text="‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢ (50 ¬µg/m¬≥)",
                    annotation_position="top right"
                )
                
                fig_pm25.update_layout(
                    xaxis_title="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà",
                    yaxis_title="PM2.5 (¬µg/m¬≥)",
                    hovermode='x unified'
                )
                
                st.plotly_chart(fig_pm25, use_container_width=True)
            else:
                st.warning("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å")
            
            # ========================================
            # 6. Heatmap/Point Map: PM2.5 ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø
            # ========================================
            st.subheader(f"üó∫Ô∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• PM2.5: {'Heatmap' if visualization_mode_pm25 == 'üå´Ô∏è Heatmap (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô)' else 'Point Colors' if visualization_mode_pm25 == 'üé® Point Colors (‡∏£‡∏∞‡∏î‡∏±‡∏ö AQI)' else 'Both'}")
            
            # üî• **‡πÄ‡∏Å‡πá‡∏ö state ‡πÉ‡∏ô session_state**
            if 'pm25_analysis_done' not in st.session_state:
                st.session_state.pm25_analysis_done = False
            
            if 'pm25_points_raw' not in st.session_state:
                st.session_state.pm25_points_raw = None
            
            if 'pm25_grid_processed' not in st.session_state:
                st.session_state.pm25_grid_processed = None
            
            if 'complaints_data_processed' not in st.session_state:
                st.session_state.complaints_data_processed = None
            
            if 'map_style_selected' not in st.session_state:
                st.session_state.map_style_selected = "Light"
            
            # üî• **‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô session_state**
            if apply_pm25_filter or not st.session_state.pm25_analysis_done:
                with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà..."):
                    # ========================================
                    # 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ
                    # ========================================
                    pm25_filtered_local = pm25_df.copy()
                    
                    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ
                    pm25_filtered_local = pm25_filtered_local[pm25_filtered_local['year'] == selected_year]
                    
                    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™
                    if selected_quarter != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                        pm25_filtered_local = pm25_filtered_local[pm25_filtered_local['quarter'] == selected_quarter]
                    
                    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    if selected_month != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                        pm25_filtered_local = pm25_filtered_local[pm25_filtered_local['month'] == selected_month]
                    
                    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≤ PM2.5
                    pm25_filtered_local = pm25_filtered_local[
                        (pm25_filtered_local['pm2_5'] >= pm25_range[0]) & 
                        (pm25_filtered_local['pm2_5'] <= pm25_range[1])
                    ]
                    
                    # ========================================
                    # 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô PM2.5
                    # ========================================
                    complaints_filtered_local = df_exploded.copy()
                    
                    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö PM2.5
                    complaints_filtered_local = complaints_filtered_local[complaints_filtered_local['year'] == selected_year]
                    
                    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™
                    if selected_quarter != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                        complaints_filtered_local = complaints_filtered_local[complaints_filtered_local['quarter'] == selected_quarter]
                    
                    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    if selected_month != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                        complaints_filtered_local = complaints_filtered_local[complaints_filtered_local['month'] == selected_month]
                    
                    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡∏ï
                    if selected_pm25_district != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                        complaints_filtered_local = complaints_filtered_local[complaints_filtered_local['district'] == selected_pm25_district]
                    
                    # üî• **‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤ PM2.5**
                    if selected_complaint_type != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
                        complaints_filtered_local = complaints_filtered_local[complaints_filtered_local['type_exploded'] == selected_complaint_type]
                    elif len(pm25_related_types) > 0:
                        complaints_filtered_local = complaints_filtered_local[complaints_filtered_local['type_exploded'].isin(pm25_related_types)]
                    
                    # ========================================
                    # 3. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                    # ========================================
                    if len(pm25_filtered_local) > 0:
                        st.info(f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ: {len(pm25_filtered_local):,} ‡∏à‡∏∏‡∏î")
                        st.info(f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô PM2.5: {len(complaints_filtered_local):,} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)")
                        st.info(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥: {count_unique_complaints(complaints_filtered_local, df_original):,} ‡πÄ‡∏Ñ‡∏™")
                        
                        # üî• **‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏∏‡∏î‡∏î‡∏¥‡∏ö PM2.5**
                        pm25_points_raw_data = pm25_filtered_local[['lat', 'lon', 'pm2_5', 'date_dt']].copy()
                        
                        # ‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
                        if len(pm25_points_raw_data) > 10000:
                            pm25_points_raw_data = pm25_points_raw_data.sample(10000, random_state=42)
                        
                        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏¥‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Heatmap (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
                        grid_size = 0.01
                        pm25_grid_data = pm25_points_raw_data.copy()
                        pm25_grid_data['lat_grid'] = (pm25_grid_data['lat'] / grid_size).round() * grid_size
                        pm25_grid_data['lon_grid'] = (pm25_grid_data['lon'] / grid_size).round() * grid_size
                        
                        pm25_grid_agg = pm25_grid_data.groupby(['lat_grid', 'lon_grid']).agg({
                            'pm2_5': 'mean',
                            'lat': 'count'
                        }).reset_index()
                        pm25_grid_agg.rename(columns={'lat': 'point_count'}, inplace=True)
                        
                        # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô session_state
                        st.session_state.pm25_points_raw = pm25_points_raw_data
                        st.session_state.pm25_grid_processed = pm25_grid_agg
                        st.session_state.complaints_data_processed = complaints_filtered_local.copy()
                        st.session_state.pm25_analysis_done = True
                        
                        st.success(f"‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {len(pm25_points_raw_data):,} ‡∏à‡∏∏‡∏î‡∏î‡∏¥‡∏ö | {len(pm25_grid_agg):,} ‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏Å‡∏£‡∏¥‡∏î")
                    else:
                        st.warning("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å")
                        st.session_state.pm25_points_raw = None
                        st.session_state.pm25_grid_processed = None
                        st.session_state.complaints_data_processed = None
            
            # üî• **‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å session_state**
            pm25_points_raw = st.session_state.pm25_points_raw
            pm25_grid = st.session_state.pm25_grid_processed
            complaints_filtered_copy = st.session_state.complaints_data_processed
            
            if pm25_points_raw is not None and len(pm25_points_raw) > 0:
                st.info(f"‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• PM2.5: {len(pm25_points_raw):,} ‡∏à‡∏∏‡∏î")
                
                # üî• **UI Controls ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà**
                st.markdown("---")
                st.markdown("### üé® ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà")
                
                with st.form("pm25_map_form"):
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        # Map style selector
                        mapbox_styles = {
                            "Street": "streets",
                            "Light": "light",
                            "Dark": "dark",
                            "Satellite": "satellite",
                        }
                        
                        map_style = st.selectbox(
                            "‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà",
                            list(mapbox_styles.keys()),
                            index=list(mapbox_styles.keys()).index(st.session_state.map_style_selected)
                            if st.session_state.map_style_selected in mapbox_styles else 1
                        )
                    
                    with col2:
                        # Opacity settings
                        if visualization_mode_pm25 in ["üå´Ô∏è Heatmap (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô)", "üìä ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö"]:
                            heatmap_opacity = st.slider(
                                "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ Heatmap",
                                min_value=0.1,
                                max_value=1.0,
                                value=0.7,
                                step=0.1
                            )
                        
                        if visualization_mode_pm25 in ["üé® Point Colors (‡∏£‡∏∞‡∏î‡∏±‡∏ö AQI)", "üìä ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö"]:
                            points_opacity = st.slider(
                                "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡∏à‡∏∏‡∏î‡∏™‡∏µ",
                                min_value=0.1,
                                max_value=1.0,
                                value=0.8,
                                step=0.1
                            )
                    
                    update_map = st.form_submit_button("üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà")
                
                if update_map:
                    st.session_state.map_style_selected = map_style
                    st.rerun()
                
                # üî• **‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà**
                def create_pm25_map():
                    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà"""
                    layers = []
                    
                    # 1. OpenStreetMap base layer
                    tile_layer = pdk.Layer(
                        "TileLayer",
                        data=None,
                        get_tile_data="https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                        opacity=1.0,
                        pickable=False,
                        max_zoom=19,
                        min_zoom=0
                    )
                    layers.append(tile_layer)
                    
                    # 2. Heatmap Layer (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
                    if visualization_mode_pm25 in ["üå´Ô∏è Heatmap (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô)", "üìä ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö"] and pm25_grid is not None:
                        heatmap_layer = pdk.Layer(
                            "HeatmapLayer",
                            data=pm25_grid,
                            get_position=['lon_grid', 'lat_grid'],
                            get_weight='pm2_5',
                            radius_pixels=60,
                            intensity=1,
                            threshold=0.05,
                            opacity=heatmap_opacity if visualization_mode_pm25 == "üå´Ô∏è Heatmap (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô)" else heatmap_opacity * 0.6,
                            pickable=True
                        )
                        layers.append(heatmap_layer)
                    
                    # 3. Point Colors Layer (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
                    if visualization_mode_pm25 in ["üé® Point Colors (‡∏£‡∏∞‡∏î‡∏±‡∏ö AQI)", "üìä ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö"]:
                        def get_aqi_color(pm25_value):
                            """‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤ PM2.5 ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏° AQI ‡πÑ‡∏ó‡∏¢"""
                            if pm25_value <= 25:
                                return [0, 255, 0, 180]      # üü¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                            elif pm25_value <= 37:
                                return [255, 255, 0, 180]    # üü° ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                            elif pm25_value <= 50:
                                return [255, 165, 0, 180]    # üü† ‡∏™‡πâ‡∏°
                            elif pm25_value <= 90:
                                return [255, 0, 0, 180]      # üî¥ ‡πÅ‡∏î‡∏á
                            elif pm25_value <= 120:
                                return [128, 0, 128, 180]    # üü£ ‡∏°‡πà‡∏ß‡∏á
                            else:
                                return [139, 69, 19, 180]    # üü§ ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
                        
                        # ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡∏î‡∏¥‡∏ö PM2.5
                        pm25_points_colored = pm25_points_raw.copy()
                        pm25_points_colored['color'] = pm25_points_colored['pm2_5'].apply(get_aqi_color)
                        
                        points_layer = pdk.Layer(
                            "ScatterplotLayer",
                            data=pm25_points_colored,
                            get_position=['lon', 'lat'],
                            get_color='color',
                            get_radius=40,
                            radius_min_pixels=2,
                            radius_max_pixels=10,
                            pickable=True,
                            opacity=points_opacity if visualization_mode_pm25 == "üé® Point Colors (‡∏£‡∏∞‡∏î‡∏±‡∏ö AQI)" else points_opacity * 0.6
                        )
                        layers.append(points_layer)
                    
                    # 4. ‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô PM2.5 (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    if complaints_filtered_copy is not None and len(complaints_filtered_copy) > 0:
                        complaints_sample = complaints_filtered_copy.sample(
                            min(5000, len(complaints_filtered_copy)), 
                            random_state=42
                        )
                        
                        complaints_layer = pdk.Layer(
                            "ScatterplotLayer",
                            data=complaints_sample,
                            get_position=['lon', 'lat'],
                            get_color=[0, 0, 255, 180],  # ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
                            get_radius=50,
                            radius_min_pixels=2,
                            radius_max_pixels=8,
                            pickable=True,
                            opacity=0.6
                        )
                        layers.append(complaints_layer)
                    
                    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
                    center_lat = pm25_points_raw['lat'].mean()
                    center_lon = pm25_points_raw['lon'].mean()
                    
                    view_state = pdk.ViewState(
                        latitude=center_lat,
                        longitude=center_lon,
                        zoom=11,
                        pitch=0,
                        bearing=0
                    )
                    
                    tooltip = {
                        "html": """
                        <div style="padding: 8px; background-color: rgba(0,0,0,0.85); color: white; 
                                    border-radius: 5px; font-size: 12px;">
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">
                                üìç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5
                            </div>
                            <div style="margin: 3px 0;">
                                <span style="color: #4ECDC4;">üìä ‡∏Ñ‡πà‡∏≤ PM2.5:</span> {pm2_5:.1f} ¬µg/m¬≥
                            </div>
                            <div style="margin: 3px 0;">
                                <span style="color: #FF6B6B;">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</span> ({lat:.4f}, {lon:.4f})
                            </div>
                            <div style="margin: 3px 0;">
                                <span style="color: #FFD166;">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> {date_dt}
                            </div>
                        </div>
                        """,
                        "style": {"color": "white"}
                    }
                    
                    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                    deck = pdk.Deck(
                        layers=layers,
                        initial_view_state=view_state,
                        tooltip=tooltip
                    )
                    
                    return deck
                
                # üî• **‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà**
                map_container = st.container()
                with map_container:
                    try:
                        deck = create_pm25_map()
                        st.pydeck_chart(deck)
                        
                        # ‡πÅ‡∏™‡∏î‡∏á legend ‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
                        if visualization_mode_pm25 == "üå´Ô∏è Heatmap (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô)":
                            st.caption("üéØ **Heatmap Mode:** ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏≠‡∏á PM2.5 (‡πÅ‡∏î‡∏á=‡∏™‡∏π‡∏á, ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á=‡∏ï‡πà‡∏≥)")
                        elif visualization_mode_pm25 == "üé® Point Colors (‡∏£‡∏∞‡∏î‡∏±‡∏ö AQI)":
                            st.caption("""
                            üé® **Point Colors Mode:** ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö PM2.5 ‡∏ï‡∏≤‡∏° AQI ‡πÑ‡∏ó‡∏¢:
                            üü¢ 0-25 | üü° 26-37 | üü† 38-50 | üî¥ 51-90 | üü£ 91-120 | üü§ >120 ¬µg/m¬≥
                            |üîµ ‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
                            """)
                        else:
                            st.caption("üìä **‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏™‡∏°:** Heatmap + Point Colors")
                        
                    except Exception as e:
                        st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: {str(e)}")
                
                # üî• **‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥**
                st.markdown("---")
                st.subheader("üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5")
                
                col_stat1, col_stat2, col_stat3 = st.columns(3)
                
                with col_stat1:
                    # ‡∏£‡∏∞‡∏î‡∏±‡∏ö AQI
                    pm25_values = pm25_points_raw['pm2_5']
                    aqi_counts = {
                        "üü¢ ‡∏î‡∏µ (0-25)": len(pm25_values[pm25_values <= 25]),
                        "üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (26-37)": len(pm25_values[(pm25_values > 25) & (pm25_values <= 37)]),
                        "üü† ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏• (38-50)": len(pm25_values[(pm25_values > 37) & (pm25_values <= 50)]),
                        "üî¥ ‡∏°‡∏µ‡∏ú‡∏•‡∏°‡∏≤‡∏Å (51-90)": len(pm25_values[(pm25_values > 50) & (pm25_values <= 90)]),
                        "üü£ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ (91-120)": len(pm25_values[(pm25_values > 90) & (pm25_values <= 120)]),
                        "üü§ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å (>120)": len(pm25_values[pm25_values > 120])
                    }
                    
                    st.write("**‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö AQI:**")
                    for level, count in aqi_counts.items():
                        percentage = (count / len(pm25_values)) * 100
                        st.write(f"{level}: {count:,} ‡∏à‡∏∏‡∏î ({percentage:.1f}%)")
                
                with col_stat2:
                    st.metric("‡∏Ñ‡πà‡∏≤ PM2.5 ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", f"{pm25_points_raw['pm2_5'].mean():.1f} ¬µg/m¬≥")
                    st.metric("‡∏Ñ‡πà‡∏≤ PM2.5 ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î", f"{pm25_points_raw['pm2_5'].max():.1f} ¬µg/m¬≥")
                    st.metric("‡∏Ñ‡πà‡∏≤ PM2.5 ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î", f"{pm25_points_raw['pm2_5'].min():.1f} ¬µg/m¬≥")
                
                with col_stat3:
                    if complaints_filtered_copy is not None:
                        unique_complaints = count_unique_complaints(complaints_filtered_copy, df_original)
                        st.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô PM2.5 (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)", f"{unique_complaints:,}")
                        if unique_complaints > 0:
                            min_date_complaint = complaints_filtered_copy['timestamp_dt'].min().date()
                            max_date_complaint = complaints_filtered_copy['timestamp_dt'].max().date()
                            st.metric("‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤", f"{min_date_complaint} ‡∏ñ‡∏∂‡∏á {max_date_complaint}")
                
                # üî• **‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà**
                col_reset, col_info = st.columns([1, 3])
                with col_reset:
                    if st.button("üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", type="secondary"):
                        st.session_state.map_style_selected = "Light"
                        st.rerun()
                
                with col_info:
                    st.info("üí° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á")
                    
            else:
                st.warning("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å")
            
            # ========================================
            # 7. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
            # ========================================
            st.subheader("üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö")
            
            if len(pm25_filtered) > 0:
                # ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                pm25_monthly = pm25_filtered.groupby('month').agg({
                    'pm2_5': ['mean', 'max', 'min', 'count']
                }).round(2)
                pm25_monthly.columns = ['‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢', '‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î', '‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•']
                pm25_monthly = pm25_monthly.reset_index()
                
                # ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ô‡∏±‡∏ö unique)
                if len(complaints_filtered) > 0:
                    complaints_monthly_unique = {}
                    for month in complaints_filtered['month'].unique():
                        month_data = complaints_filtered[complaints_filtered['month'] == month]
                        unique_count_month = count_unique_complaints(month_data, df_original)
                        complaints_monthly_unique[month] = unique_count_month
                    
                    complaints_monthly = pd.DataFrame({
                        'month': list(complaints_monthly_unique.keys()),
                        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': list(complaints_monthly_unique.values())
                    })
                    
                    # ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    comparison_df = pd.merge(
                        pm25_monthly,
                        complaints_monthly,
                        on='month',
                        how='left'
                    )
                    comparison_df['‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'] = comparison_df['month'].apply(lambda x: f'‡πÄ‡∏î‡∏∑‡∏≠‡∏ô {x}')
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    st.dataframe(
                        comparison_df[['‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢', '‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î', '‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']],
                        use_container_width=True
                    )
                    
                    # ‡πÅ‡∏™‡∏î‡∏á note
                    st.caption("‚ÑπÔ∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥")
                else:
                    pm25_monthly['‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'] = pm25_monthly['month'].apply(lambda x: f'‡πÄ‡∏î‡∏∑‡∏≠‡∏ô {x}')
                    st.dataframe(
                        pm25_monthly[['‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢', '‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î', '‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•']],
                        use_container_width=True
                    )
                    
                    st.info("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å")
    
    else:
        # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
        st.info("üëà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå PM2.5' ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå")
        
        # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        col1, col2 = st.columns(2)
        
        with col1:
            st.subheader("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á")
            st.dataframe(pm25_df[['date_str', 'lat', 'lon', 'pm2_5', 'quarter', 'month']].head(10))
            
        with col2:
            st.subheader("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á")
            st.dataframe(df_exploded[['timestamp_dt', 'type_exploded', 'district', 'organization', 'quarter', 'month']].head(10))
        
        # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
        st.subheader("üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
        
        col_stat1, col_stat2, col_stat3, col_stat4 = st.columns(4)
        
        with col_stat1:
            st.metric("‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", f"{len(available_years)} ‡∏õ‡∏µ")
        
        with col_stat2:
            st.metric("‡∏Ñ‡πà‡∏≤ PM2.5 ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", f"{pm25_df['pm2_5'].mean():.1f} ¬µg/m¬≥")
        
        with col_stat3:
            st.metric("‡∏Ñ‡πà‡∏≤ PM2.5 ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î", f"{pm25_df['pm2_5'].max():.1f} ¬µg/m¬≥")
        
        with col_stat4:
            st.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", f"{len(pm25_df):,} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")